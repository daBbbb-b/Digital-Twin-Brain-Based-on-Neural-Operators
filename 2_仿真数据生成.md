# 仿真数据生成任务指导说明

## 1. 任务概述
本任务旨在构建一个基于神经动力学方程的仿真数据集，用于训练和验证神经算子模型。数据集包含基于常微分方程（ODE）和偏微分方程（PDE）生成的神经活动及对应的fMRI BOLD信号。

## 2. 方法与原理

### 2.1 动力学模型

#### 2.1.1 常微分方程 (ODE) - 兴奋-抑制 (E-I) 模型
我们使用经典的Wilson-Cowan类型的E-I模型来模拟神经元群体的活动。该模型考虑了兴奋性群体(E)和抑制性群体(I)之间的相互作用。

**方程：**
$$ \tau_E \frac{dE}{dt} = -E + S_E(w_{EE}E - w_{EI}I + G \cdot (C E) + u + \xi) $$
$$ \tau_I \frac{dI}{dt} = -I + S_I(w_{IE}E - w_{II}I + u + \xi) $$

其中：
- $E, I$: 兴奋性和抑制性群体的平均发放率
- $C$: 连接矩阵（可以是有效连接EC或白质结构连接SC）
- $u$: 外部任务刺激
- $\xi$: 随机噪声
- $S(\cdot)$: Sigmoid激活函数

#### 2.1.2 偏微分方程 (PDE) - 阻尼波动方程
我们使用定义在皮层图结构上的阻尼波动方程来模拟神经活动的传播。
注意：在没有皮层表面网格文件(.gii)的情况下，我们使用结构连接矩阵(SC)构建图拉普拉斯算子(Graph Laplacian)来近似皮层几何结构。

**方程：**
$$ \frac{\partial^2 \phi}{\partial t^2} + \gamma \frac{\partial \phi}{\partial t} + c^2 L \phi = S(\phi) + u $$

其中：
- $\phi$: 神经场活动
- $L$: 图拉普拉斯算子 (Graph Laplacian)，由皮层结构连接定义
- $\gamma$: 阻尼系数
- $c$: 传播速度

### 2.2 血氧动力学模型 (Balloon-Windkessel Model)
为了将模拟的神经活动转换为fMRI BOLD信号，我们使用Friston等人提出的Balloon模型。

**方程：**
涉及血流量($f$)、血容量($v$)和脱氧血红蛋白含量($q$)的动态变化。
$$ \dot{s} = z - \kappa s - \gamma(f-1) $$
$$ \dot{f} = s $$
$$ \tau \dot{v} = f - v^{1/\alpha} $$
$$ \tau \dot{q} = f \frac{1-(1-E_0)^{1/f}}{E_0} - q v^{1/\alpha - 1} $$

最终BOLD信号 $y$ 是 $v$ 和 $q$ 的非线性函数。

### 2.3 刺激与噪声
- **任务刺激**: 使用Boxcar函数模拟组块设计(Block Design)的任务刺激。
- **噪声**: 使用Ornstein-Uhlenbeck过程生成具有时间相关性的有色噪声，模拟自发脑活动。

## 3. 数据生成步骤

1.  **加载连接矩阵**:
    - 读取 `dataset/BNA_matrix_binary_246x246.csv` 作为结构连接 (SC)。
    - 生成或加载有效连接 (EC) 矩阵（目前使用虚拟生成的稀疏矩阵）。

2.  **配置仿真参数**:
    - 时间步长 $dt = 0.5$ ms (神经动力学仿真)
    - 仿真时长 $T = 20$ s (或更长)
    - 采样率: 下采样至 100 ms 或 TR (如 2s) 以匹配fMRI数据。

3.  **运行仿真**:
    - **ODE (EC)**: 使用EC矩阵运行EI模型。
    - **ODE (SC)**: 使用SC矩阵运行EI模型。
    - **PDE (Cortical Surface)**: 使用皮层Surface网格 (`.gii`文件) 构建拉普拉斯算子，运行波动方程模型。
      - 自动加载 `dataset/T103/anat/sub-01_hemi-L_midthickness.surf.gii`。
      - 顶点数量约为 32k (左半球)。
      - 内存优化：在线生成噪声，仅保存降采样后的神经活动。

4.  **保存数据**:
    - 将仿真结果保存为 `.pkl` 文件。

## 4. 数据格式

生成的数据保存在 `dataset/simulation_data/` 目录下。每个样本是一个 pickle 文件，包含一个字典：

```python
{
    'time_points': np.array([...]),      # 时间点序列 (T,)
    'neural_activity': np.array([...]),  # 神经活动 (T, N_nodes)
    'bold_signal': np.array([...]),      # BOLD信号 (T, N_nodes)
    # 'stimulus': ... (PDE仿真中因数据量过大不保存完整刺激历史)
}
```

## 5. 运行说明

运行以下命令生成仿真数据：

```bash
python examples/01_generate_simulation_data.py
```

程序将输出日志到控制台和 `simulation_generation.log` 文件，记录生成过程、使用的矩阵大小和保存路径。

## 6. 代码结构

- `dynamics/`: 包含 ODE (`ode_models.py`)、PDE (`pde_models.py`) 和 Balloon (`balloon_model.py`) 模型定义。
- `simulation/`: 包含仿真器 (`ode_simulator.py`, `pde_simulator.py`) 和刺激生成器 (`stimulation_generator.py`)。
- `examples/`: 包含主生成脚本。
