# 仿真数据生成任务指导说明

## 1. 任务概述
本任务旨在构建一个基于神经动力学方程的仿真数据集，用于训练和验证神经算子模型。数据集包含基于常微分方程（ODE）和偏微分方程（PDE）生成的神经活动及对应的fMRI BOLD信号。

## 2. 方法与原理

### 2.1 动力学模型

#### 2.1.1 常微分方程 (ODE) - 兴奋-抑制 (E-I) 模型
我们使用经典的Wilson-Cowan类型的E-I模型来模拟神经元群体的活动。该模型考虑了兴奋性群体(E)和抑制性群体(I)之间的相互作用。

**方程：**
$$ \tau_E \frac{dE}{dt} = -E + S_E(w_{EE}E - w_{EI}I + G \cdot (C E) + u + \xi) $$
$$ \tau_I \frac{dI}{dt} = -I + S_I(w_{IE}E - w_{II}I + u + \xi) $$

其中：
- $E, I$: 兴奋性和抑制性群体的平均发放率
- $C$: 连接矩阵。根据任务要求，ODE动力学作用于：
    1. **有效连接 (EC)**: 反映脑区间的定向因果影响。
    2. **组平均白质结构连接 (SC)**: 反映脑区间的物理纤维连接。
- $u$: 外部任务刺激（任务态刺激）。
- $\xi$: 随机噪声（随机ODE）。
- $S(\cdot)$: Sigmoid激活函数。

#### 2.1.2 偏微分方程 (PDE) - 阻尼波动方程
我们使用定义在皮层图结构上的阻尼波动方程来模拟神经活动的传播。

**方程：**
$$ \frac{\partial^2 \phi}{\partial t^2} + \gamma \frac{\partial \phi}{\partial t} + c^2 L \phi = S(\phi) + u + \xi $$

其中：
- $\phi$: 神经场活动。
- $L$: 图拉普拉斯算子 (Graph Laplacian)，由**皮层结构连接**定义。
- $\gamma$: 阻尼系数。
- $c$: 传播速度。
- $u$: 外部任务刺激。
- $\xi$: 随机噪声（随机PDE）。

### 2.2 刺激生成策略 (Stimulation Generation)

为了构建用于神经算子反演的高质量数据集，我们设计了 **Task-based 多尺度联合刺激** 策略，确保动力学的自洽性和刺激的可辨识性。

1.  **时间结构 (Task Schedule)**:
    - 一个完整的仿真 Run 时长约 **600秒**。
    - 包含 **15-25 个 Task 段**，每个 Task 持续 **5-20 秒**。
    - Task 之间状态连续演化，不重置，模拟真实的连续脑活动。

2.  **ODE 刺激 (网络层级)**:
    - **稀疏激活**: 在每个 Task 内，随机选择 1-3 个刺激通道（对应脑区）。
    - **波形设计**: 采用“近似常值 + 平滑边界” (Smooth Boxcar/Sigmoid) 的波形，避免阶跃带来的数值不稳定。
    - **幅度**: 随机采样自 $[-2.0, -0.5] \cup [0.5, 2.0]$。

3.  **PDE 刺激 (皮层连续空间)**:
    - **空间局部性**: 在皮层表面随机选择 1-3 个种子点 (Seed)。
    - **高斯 Patch**: 以种子点为中心生成高斯空间分布 $\phi(s) = \exp(-d(s, s_0)^2 / 2\sigma_s^2)$，其中 $\sigma_s \in [5, 20]$ mm。
    - **时空同步**: PDE 刺激的时间包络与 ODE Task 严格同步，形成多尺度的联合扰动。

### 2.3 血氧动力学模型 (Balloon-Windkessel Model)
为了将模拟的神经活动转换为fMRI BOLD信号，我们使用Friston等人提出的Balloon模型。

**方程：**
涉及血流量($f$)、血容量($v$)和脱氧血红蛋白含量($q$)的动态变化。
$$ \dot{s} = z - \kappa s - \gamma(f-1) $$
$$ \dot{f} = s $$
$$ \tau \dot{v} = f - v^{1/\alpha} $$
$$ \tau \dot{q} = f \frac{1-(1-E_0)^{1/f}}{E_0} - q v^{1/\alpha - 1} $$

最终BOLD信号 $y$ 是 $v$ 和 $q$ 的非线性函数。

## 3. 数据生成步骤

1.  **加载连接矩阵**:
    - 读取 `dataset/BNA_matrix_binary_246x246.csv` 作为结构连接 (SC)。
    - 使用刘泉影等人的方法获取有效连接 (EC) 矩阵。
    - 加载皮层表面网格 (`.gii`文件) 构建皮层结构连接的拉普拉斯算子。

2.  **配置仿真参数**:
    - **时间步长**: $dt = 0.1$ s (100ms)。注意：为了适应长时程仿真(600s)，我们增大了时间步长，这对于BOLD信号（慢动态）是足够的。
    - **仿真时长**: $T_{run} = 600$ s (包含多个 Task)。
    - **采样间隔**: 与 $dt$ 保持一致。

3.  **运行仿真**:
    - **初始化**: 生成 Task 调度表和对应的刺激函数 $u(t)$ 及 $u_{pde}(s,t)$。
    - **ODE (EC/SC)**: 使用 E-I 模型进行网络动力学演化。
    - **PDE (Cortical)**: 使用阻尼波动方程进行皮层场演化。
    - **噪声注入**: 在每一步注入统计特性稳定的噪声 $\xi$。

4.  **保存数据**:
    - 将仿真结果保存为 `.pkl` 文件。
    - **存储优化**: 保存完整的刺激配置 (`stimulus_config`)，按其中的随机种子和参数可 100% 复原 ODE/PDE 刺激（无需保存巨大矩阵）。

## 4. 数据格式

仿真生成的数据以 `.pkl` (Pickle) 格式保存于 `dataset/simulation_data/` 目录下。为了支持仿真的完全复现和神经算子的反演训练，输出字典包含了动力学参数、初始状态、随机种子及刺激配置。

#### 4.1 ODE 仿真数据格式 (EI 或 Bilinear 模型)

每个样本包含以下字段：

```python
{
    'time_points': np.array,          # 降采样后的时间点 (T_sampled,)
    'bold_signal': np.array,          # BOLD信号 (T_sampled, N_nodes)

    # 动力学参数 (包含连接矩阵)
    'model_params': {
        'C': np.array,                # EI模型的结构/有效连接矩阵 (N, N)，如果是Bilinear则为输入增益矩阵 (N, K)
        'A': np.array,                # EI为NONE，Bilinear模型的基准连接 (N, N)
        'B': np.array,                # EI为NONE，Bilinear模型的调制矩阵 (K, N, N)

    },

    # 初始状态 (用于完全复现)
    'initial_state': np.array,        # EI为 (2*N,), Bilinear为 (N,)

    # 刺激配置 (用于复现 u(t))
    'stimulus_config': {
        'type': 'task_based_ode',
        'n_channels': 5,
        'tasks': [
            {
                'index': 0,
                'range': (10.0, 25.0),   # 开始/结束时间 (s)
                'channels': [1, 3],      # 激活的脑区或通道索引
                'amplitudes': [1.2, -0.8] # 刺激强度
            },
            # ... 更多 Task
        ]
    },

    'metadata': {
        'model_type': 'EI',           # 或 'bilinear'
        'dt': 0.1,                    # 仿真步长 (s)
        'duration': 200.0,            # 总时长 (s)
        'sampling_interval': 50.0,    # 采样间隔 (ms)
        'noise_level': 0.01,          # 噪声强度
        'noise_seed': 42              # 随机种子 (确保噪声序列可复现)
    }
}
```

**（更新）实际使用的 `stimulus_config` 结构（可完全复现刺激）：**

```python
{
    'type': 'mixed_task_ode',
    'n_channels': N,              # 通道/脑区数
    'global_seed': 42,            # 调度与背景噪声的全局种子
    'noise': {                    # 背景噪声参数（可复现）
        'sigma': 0.05,
        'color': 'ou',
        'tau_noise': 100.0,
        'seed': 123456789
    },
    'tasks': [
        {
            'index': 0,
            'range': (t0_ms, t1_ms),          # 任务时间窗口（毫秒）
            'type': 'boxcar' | 'impulse' | 'continuous',
            'channels': [...],               # 受刺激脑区/通道
            'amplitudes': [...],             # 对应幅值（可正可负）
            'task_seed': 987654321,          # 该任务波形的随机种子
            'specific_params': {             # 按波形存储的细节
                # boxcar:  {'actual_end_time': ...}
                # impulse: {'interval_mean': 2000.0}
                # continuous: {'n_freqs': 5}
            }
        },
        ...
    ]
}
```

重建 ODE 刺激步骤（无需保存完整刺激矩阵）：
1) 设定 `global_seed`（用于背景噪声等全局流程）。
2) 对每个 task：
   - 用 `task_seed` 构造 `rng = np.random.RandomState(task_seed)`。
   - 根据 `type` 生成时间包络：
     - boxcar：用 `_smooth_boxcar(t, t0, specific_params['actual_end_time'])`。
     - impulse：用 `_impulse_train(..., interval_mean=2000.0, rng=rng)`。
     - continuous：用 `_continuous_signal(..., rng=rng)`。
   - 将 envelope * amplitude 叠加到对应 `channels`。
3) 背景噪声：调用 `generate_noise(**stimulus_config['noise'])` 叠加。

#### 4.2 PDE 仿真数据格式 (Wave Equation 模型)

PDE 仿真侧重于皮层表面的时空演化，其输出格式如下：

```python
{
    'time_points': np.array,          # 降采样后的时间点 (T_sampled,)
    'bold_signal': np.array,          # BOLD信号 (T_sampled, N_nodes)

    # 初始状态 (包含位移 u 和速度 v)
    'initial_state': np.array,        # 维度为 (2 * N_nodes,)

    # 刺激配置 (包含空间种子点信息)
    'stimulus_config': {
        'type': 'task_based_pde',
        'tasks': [
            {
                'index': 0,
                'range': (15.0, 30.0),   # 该任务段开始/结束时间 (s)
                'seeds': [1024, 500],    # 皮层顶点索引 (Seed points)
                'sigma_s': 12.5,         # 空间高斯核宽度 (mm)
                'amplitudes': [2.0, 1.5]
            }
        ]
    },

    'metadata': {
        'model_type': 'Wave_PDE',
        'dt': 0.1,
        'duration': 200.0,
        'sampling_interval': 50.0,
        'noise_level': 0.01,
        'noise_seed': 123,
    }
}
```

**（更新）实际使用的 `stimulus_config` 结构（PDE，可复现任务部分）：**

```python
{
    'type': 'mixed_task_pde',
    'tasks': [
        {
            'index': 0,
            'range': (t0_ms, t1_ms),
            'type': 'boxcar' | 'impulse' | 'continuous',
            'seeds': [...],        # 皮层顶点索引
            'amplitude': 1.5,      # 振幅（符号表示正/负扰动）
            'sigma_s': 12.5,       # 空间高斯核宽度
            'rng_seed': 112233     # 波形随机种子（时间包络）
        },
        ...
    ]
}
```

重建 PDE 刺激步骤：
1) 对每个 task，构造 `rng = np.random.RandomState(rng_seed)`。
2) 按 `type` 生成时间包络（同 ODE 的三类波形，使用对应 rng）。
3) 空间分布：对每个 `seed` 生成高斯 patch（宽度 `sigma_s`），叠加后乘以 amplitude 与时间包络。
4) PDE 背景噪声在 PDESimulator 内部生成；如需完全复现，可在仿真器层记录并重放噪声种子/参数（当前任务部分已可复现）。

### 5. 刺激复现方法

刺激的生成和复现依赖于 `simulation/stimulation_generator.py` 中的 `StimulationGenerator`。核心要点：

- 生成：`generate_task_schedule` + `generate_ode_stimulus` / `generate_pde_stimulus` 会在 config 中写入全局种子、task_seed 以及波形/噪声参数，确保后续可复现。
- 复现：参照本节 “重建 ODE/PDE 刺激步骤” 使用 `stimulus_config` 中的 seeds 与参数即可重建完整刺激矩阵；无需保存原始 `(T,N)` 矩阵。
- 噪声：ODE 背景噪声参数在 `stimulus_config['noise']` 中记录；PDE 背景噪声在 PDESimulator 内部，如需完全复现可在仿真器中同样记录噪声参数。

### 6. 参考文件

- `simulation/stimulation_generator.py`: 刺激生成器的实现。
- `simulation/ode_simulator.py`: ODE 仿真器。
- `simulation/pde_simulator.py`: PDE 仿真器。

通过以上文件和方法，可以完全复现仿真数据中的刺激配置。
