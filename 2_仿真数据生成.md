# 仿真数据生成任务指导说明

## 1. 任务概述
本任务旨在构建一个基于神经动力学方程的仿真数据集，用于训练和验证神经算子模型。数据集包含基于常微分方程（ODE）和偏微分方程（PDE）生成的神经活动及对应的fMRI BOLD信号。

## 2. 方法与原理

### 2.1 动力学模型

#### 2.1.1 常微分方程 (ODE) - 兴奋-抑制 (E-I) 模型
我们使用经典的Wilson-Cowan类型的E-I模型来模拟神经元群体的活动。该模型考虑了兴奋性群体(E)和抑制性群体(I)之间的相互作用。

**方程：**
$$ \tau_E \frac{dE}{dt} = -E + S_E(w_{EE}E - w_{EI}I + G \cdot (C E) + u + \xi) $$
$$ \tau_I \frac{dI}{dt} = -I + S_I(w_{IE}E - w_{II}I + u + \xi) $$

其中：
- $E, I$: 兴奋性和抑制性群体的平均发放率
- $C$: 连接矩阵。根据任务要求，ODE动力学作用于：
    1. **有效连接 (EC)**: 反映脑区间的定向因果影响。
    2. **组平均白质结构连接 (SC)**: 反映脑区间的物理纤维连接。
- $u$: 外部任务刺激（任务态刺激）。
- $\xi$: 随机噪声（随机ODE）。
- $S(\cdot)$: Sigmoid激活函数。

#### 2.1.2 偏微分方程 (PDE) - 阻尼波动方程
我们使用定义在皮层图结构上的阻尼波动方程来模拟神经活动的传播。

**方程：**
$$ \frac{\partial^2 \phi}{\partial t^2} + \gamma \frac{\partial \phi}{\partial t} + c^2 L \phi = S(\phi) + u + \xi $$

其中：
- $\phi$: 神经场活动。
- $L$: 图拉普拉斯算子 (Graph Laplacian)，由**皮层结构连接**定义。
- $\gamma$: 阻尼系数。
- $c$: 传播速度。
- $u$: 外部任务刺激。
- $\xi$: 随机噪声（随机PDE）。

### 2.2 刺激生成策略 (Stimulation Generation)

为了构建用于神经算子反演的高质量数据集，我们设计了 **Task-based 多尺度联合刺激** 策略，确保动力学的自洽性和刺激的可辨识性。

1.  **时间结构 (Task Schedule)**:
    - 一个完整的仿真 Run 时长约 **600秒**。
    - 包含 **15-25 个 Task 段**，每个 Task 持续 **5-20 秒**。
    - Task 之间状态连续演化，不重置，模拟真实的连续脑活动。

2.  **ODE 刺激 (网络层级)**:
    - **稀疏激活**: 在每个 Task 内，随机选择 1-3 个刺激通道（对应脑区）。
    - **波形设计**: 采用“近似常值 + 平滑边界” (Smooth Boxcar/Sigmoid) 的波形，避免阶跃带来的数值不稳定。
    - **幅度**: 随机采样自 $[-2.0, -0.5] \cup [0.5, 2.0]$。

3.  **PDE 刺激 (皮层连续空间)**:
    - **空间局部性**: 在皮层表面随机选择 1-3 个种子点 (Seed)。
    - **高斯 Patch**: 以种子点为中心生成高斯空间分布 $\phi(s) = \exp(-d(s, s_0)^2 / 2\sigma_s^2)$，其中 $\sigma_s \in [5, 20]$ mm。
    - **时空同步**: PDE 刺激的时间包络与 ODE Task 严格同步，形成多尺度的联合扰动。

### 2.3 血氧动力学模型 (Balloon-Windkessel Model)
为了将模拟的神经活动转换为fMRI BOLD信号，我们使用Friston等人提出的Balloon模型。

**方程：**
涉及血流量($f$)、血容量($v$)和脱氧血红蛋白含量($q$)的动态变化。
$$ \dot{s} = z - \kappa s - \gamma(f-1) $$
$$ \dot{f} = s $$
$$ \tau \dot{v} = f - v^{1/\alpha} $$
$$ \tau \dot{q} = f \frac{1-(1-E_0)^{1/f}}{E_0} - q v^{1/\alpha - 1} $$

最终BOLD信号 $y$ 是 $v$ 和 $q$ 的非线性函数。

## 3. 数据生成步骤

1.  **加载连接矩阵**:
    - 读取 `dataset/BNA_matrix_binary_246x246.csv` 作为结构连接 (SC)。
    - 使用刘泉影等人的方法获取有效连接 (EC) 矩阵。
    - 加载皮层表面网格 (`.gii`文件) 构建皮层结构连接的拉普拉斯算子。

2.  **配置仿真参数**:
    - **时间步长**: $dt = 0.1$ s (100ms)。注意：为了适应长时程仿真(600s)，我们增大了时间步长，这对于BOLD信号（慢动态）是足够的。
    - **仿真时长**: $T_{run} = 600$ s (包含多个 Task)。
    - **采样间隔**: 与 $dt$ 保持一致。

3.  **运行仿真**:
    - **初始化**: 生成 Task 调度表和对应的刺激函数 $u(t)$ 及 $u_{pde}(s,t)$。
    - **ODE (EC/SC)**: 使用 E-I 模型进行网络动力学演化。
    - **PDE (Cortical)**: 使用阻尼波动方程进行皮层场演化。
    - **噪声注入**: 在每一步注入统计特性稳定的噪声 $\xi$。

4.  **保存数据**:
    - 将仿真结果保存为 `.pkl` 文件。
    - **存储优化**: 保存完整的刺激配置 (`stimulus_config`) 而非巨大的时空矩阵，以便后续复现和反演训练。

## 4. 数据格式

(注意：生成的数据集没有上传仓库，已经上传到scnet共享文件，建议下载后放在 `dataset/simulation_data/` 目录下)

ode生成的数据保存在 `dataset/simulation_data/` 目录下。每个样本是一个 pickle 文件，包含一个字典：

```python
{
    'time_points': np.array
    'bold_signal': np.array([...]),      # BOLD信号 (T, N_nodes)
    
    # 刺激配置 (用于复现 u(t) 和反演 Ground Truth)
    'stimulus_config': {
        'type': 'task_based_ode',        # 或 'task_based_pde'
        'n_tasks': 20,
        'tasks': [
            {
                'index': 0,
                'range': (10.0, 25.0),   # 开始时间, 结束时间 (秒)
                'channels': [1, 3],      # 激活通道 (ODE)
                'amplitudes': [1.2, -0.8],
                'seeds': [1024, 500],    # 顶点索引 (PDE)
                'sigma_s': 12.5
            },
            # ... 更多 Task
        ]
    },
    
    'metadata': {
        'model_type': 'EI_ODE',
        'connectivity_type': 'EC',
        'dt': 0.1,
        'sampling_interval': 50.0
    }
}
```

## 5. 运行说明

运行以下命令生成仿真数据：

```bash
python examples/01_generate_simulation_data.py
```

程序将输出进度信息，记录生成过程、使用的矩阵大小和保存路径。

## 6. 代码结构

- `dynamics/`: 包含 ODE (`ode_models.py`)、PDE (`pde_models.py`) 和 Balloon (`balloon_model.py`) 模型定义。
- `simulation/`: 包含仿真器 (`ode_simulator.py`, `pde_simulator.py`) 和刺激生成器 (`stimulation_generator.py`)。
- `examples/`: 包含主生成脚本。
